version: 2.1

# ==============================================================================
# Orbs - Reusable Configuration Packages
# Using the official CircleCI Rust orb to simplify CI/CD configuration.
# Documentation: https://circleci.com/developer/orbs/orb/circleci/rust
# ==============================================================================
orbs:
  rust: circleci/rust@1.8.0

# ==============================================================================
# Job Definitions
# Each job represents a collection of steps to be executed in a specific environment.
# ==============================================================================
jobs:
  # ------------------------------------------------------------------------------
  # Job: Check Code Formatting
  # Ensures all Rust code adheres to the standard formatting guidelines using `cargo fmt`.
  # ------------------------------------------------------------------------------
  check_format:
    executor:
      name: rust/default
      tag: '1.85'
    steps:
      - checkout
      - run:
          name: Check code format
          command: cargo fmt -- --check

  # ------------------------------------------------------------------------------
  # Job: Lint Checks
  # Runs `cargo clippy` to catch common mistakes and improve code quality.
  # Fails on any warnings (`-D warnings`).
  # ------------------------------------------------------------------------------
  lint:
    executor:
      name: rust/default
      tag: '1.85'
    steps:
      - checkout
      # Restore cached dependencies to speed up the process
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "Cargo.toml" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-
      - run:
          name: Run clippy
          command: cargo clippy --all-targets --all-features -- -D warnings
      # Save cache for future runs
      - save_cache:
          key: v1-dependencies-{{ checksum "Cargo.toml" }}
          paths:
            - "~/.cargo/registry"
            - "~/.cargo/git"
            - "target"

  # ------------------------------------------------------------------------------
  # Job: Build Project
  # Compiles the project in both debug and release modes to ensure it builds successfully.
  # ------------------------------------------------------------------------------
  build:
    executor:
      name: rust/default
      tag: '1.85'
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "Cargo.toml" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-
      - run:
          name: Build project (debug)
          command: cargo build --verbose
      - run:
          name: Build project (release)
          command: cargo build --release --verbose
      - save_cache:
          key: v1-dependencies-{{ checksum "Cargo.toml" }}
          paths:
            - "~/.cargo/registry"
            - "~/.cargo/git"
            - "target"
      # Persist the `target` directory to the workspace for downstream jobs
      - persist_to_workspace:
          root: .
          paths:
            - target

  # ------------------------------------------------------------------------------
  # Job: Run Tests
  # Executes all unit and integration tests using `cargo test`.
  # ------------------------------------------------------------------------------
  test:
    executor:
      name: rust/default
      tag: '1.85'
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "Cargo.toml" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-
      # Attach the workspace to access build artifacts from the `build` job
      - attach_workspace:
          at: .
      - run:
          name: Run tests
          command: cargo test --verbose

  # ------------------------------------------------------------------------------
  # Job: Generate Code Coverage
  # Generates a code coverage report using `cargo-llvm-cov` and uploads it to Coveralls.
  # ------------------------------------------------------------------------------
  coverage:
    executor:
      name: rust/default
      tag: '1.85'
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "Cargo.toml" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-
      # Attach the workspace to access build artifacts from the `build` job
      - attach_workspace:
          at: .
      - run:
          name: Install cargo-llvm-cov
          command: |
            cargo install cargo-llvm-cov --version 0.6.21 --locked
            rustup component add llvm-tools-preview
      - run:
          name: Generate coverage report
          command: |
            # Auto-detect package name from Cargo.toml to keep the command generic
            PACKAGE_NAME=$(grep "^name = " Cargo.toml | head -n 1 | sed 's/name = "\(.*\)"/\1/')
            echo "üì¶ Detected package: $PACKAGE_NAME"
            # Generate LCOV report for Coveralls
            cargo-llvm-cov --package "$PACKAGE_NAME" \
              --lcov --output-path coverage.lcov \
              --ignore-filename-regex "(\.cargo/registry|\.rustup/)"
            # Generate a text report for console output
            cargo-llvm-cov --package "$PACKAGE_NAME" \
              --ignore-filename-regex "(\.cargo/registry|\.rustup/)" \
              | tee coverage.txt
      - run:
          name: Display coverage summary
          command: |
            echo "================================"
            echo "Code Coverage Summary"
            echo "================================"
            cat coverage.txt
      - run:
          name: Upload coverage to Coveralls
          command: |
            # Only upload if the COVERALLS_REPO_TOKEN is set
            if [ -n "$COVERALLS_REPO_TOKEN" ]; then
              echo "üì§ Uploading coverage report to Coveralls..."
              curl -sL https://coveralls.io/coveralls-linux.tar.gz | tar -xz
              ./coveralls report coverage.lcov \
                --repo-token="$COVERALLS_REPO_TOKEN" \
                --service-name=circleci \
                --service-number="$CIRCLE_BUILD_NUM" \
                --commit="$CIRCLE_SHA1" \
                --branch="$CIRCLE_BRANCH"
              echo "‚úÖ Coverage report uploaded to Coveralls"
            else
              echo "‚ö†Ô∏è  COVERALLS_REPO_TOKEN not set, skipping upload"
            fi
      - save_cache:
          key: v1-dependencies-{{ checksum "Cargo.toml" }}
          paths:
            - "~/.cargo/registry"
            - "~/.cargo/git"
            - "target"
      # Store coverage reports as artifacts
      - store_artifacts:
          path: coverage.lcov
      - store_artifacts:
          path: coverage.txt

  # ------------------------------------------------------------------------------
  # Job: Build Documentation
  # Generates API documentation using `rustdoc`.
  # ------------------------------------------------------------------------------
  doc:
    executor:
      name: rust/default
      tag: '1.85'
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "Cargo.toml" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-
      - run:
          name: Generate documentation
          command: cargo doc --no-deps --verbose
      # Store the generated documentation as an artifact
      - store_artifacts:
          path: target/doc
          destination: doc

  # ------------------------------------------------------------------------------
  # Job: Security Audit
  # Checks for security vulnerabilities in dependencies using `cargo-audit`.
  # ------------------------------------------------------------------------------
  security_audit:
    executor:
      name: rust/default
      tag: '1.85'
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "Cargo.toml" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-
      - run:
          name: Install cargo-audit
          command: cargo install cargo-audit
      - save_cache:
          key: v1-dependencies-{{ checksum "Cargo.toml" }}
          paths:
            - "~/.cargo/registry"
            - "~/.cargo/git"
      - run:
          name: Run security audit
          command: cargo audit

# ==============================================================================
# Workflow Definitions
# Orchestrates the execution of jobs, defining their order and dependencies.
# ==============================================================================
workflows:
  version: 2

  # ------------------------------------------------------------------------------
  # Workflow: Main Build and Test Pipeline
  # Triggered on every commit to any branch.
  # ------------------------------------------------------------------------------
  build_and_test:
    jobs:
      # Stage 1: Run fast, parallel checks for immediate feedback
      - check_format
      - lint

      # Stage 2: Build the project after initial checks pass
      - build:
          requires:
            - check_format
            - lint

      # Stage 3: Run validation jobs in parallel after a successful build
      - test:
          requires:
            - build
      - doc:
          requires:
            - build
      - security_audit:
          requires:
            - build

      # Stage 4: Generate and upload code coverage after tests pass
      - coverage:
          requires:
            - test

  # ------------------------------------------------------------------------------
  # Workflow: Nightly Security Audit
  # Runs a security audit daily at midnight UTC on production branches.
  # ------------------------------------------------------------------------------
  nightly_security:
    triggers:
      - schedule:
          # Cron syntax for daily at 00:00 UTC
          cron: "0 0 * * *"
          filters:
            branches:
              only:
                - main
                - master
    jobs:
      - security_audit
